<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .event { margin: 5px 0; padding: 5px; background-color: #f8f9fa; border-left: 3px solid #007bff; }
        .timestamp { color: #6c757d; font-size: 0.9em; }
    </style>
</head>
<body>
    <h1>WebSocket Connection Test</h1>
    <div id="status" class="status disconnected">Disconnected</div>

    <h2>Events:</h2>
    <div id="events"></div>

    <h2>Actions:</h2>
    <button onclick="subscribeToToken()">Subscribe to Token</button>
    <button onclick="subscribeToMarket()">Subscribe to Market</button>
    <button onclick="sendPing()">Send Ping</button>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io('http://localhost:3001', {
            transports: ['websocket', 'polling']
        });

        const statusDiv = document.getElementById('status');
        const eventsDiv = document.getElementById('events');

        function addEvent(message) {
            const eventDiv = document.createElement('div');
            eventDiv.className = 'event';
            eventDiv.innerHTML = `
                <div class="timestamp">${new Date().toLocaleTimeString()}</div>
                <div>${message}</div>
            `;
            eventsDiv.appendChild(eventDiv);
            eventsDiv.scrollTop = eventsDiv.scrollHeight;
        }

        function updateStatus(connected) {
            if (connected) {
                statusDiv.textContent = 'Connected';
                statusDiv.className = 'status connected';
            } else {
                statusDiv.textContent = 'Disconnected';
                statusDiv.className = 'status disconnected';
            }
        }

        socket.on('connect', () => {
            addEvent('Connected to WebSocket server');
            updateStatus(true);
        });

        socket.on('disconnect', () => {
            addEvent('Disconnected from WebSocket server');
            updateStatus(false);
        });

        socket.on('token_price_update', (data) => {
            addEvent(`Price Update: ${JSON.stringify(data, null, 2)}`);
        });

        socket.on('new_transaction', (data) => {
            addEvent(`New Transaction: ${JSON.stringify(data, null, 2)}`);
        });

        socket.on('market_update', (data) => {
            addEvent(`Market Update: ${JSON.stringify(data, null, 2)}`);
        });

        socket.on('pong', () => {
            addEvent('Pong received');
        });

        function subscribeToToken() {
            socket.emit('subscribe_token', { tokenAddress: '0x1e46c31cf3017' });
            addEvent('Subscribed to token: 0x1e46c31cf3017');
        }

        function subscribeToMarket() {
            socket.emit('subscribe_market');
            addEvent('Subscribed to market updates');
        }

        function sendPing() {
            socket.emit('ping');
            addEvent('Ping sent');
        }
    </script>
</body>
</html>